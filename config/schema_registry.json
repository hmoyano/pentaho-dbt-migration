{
  "snowflake_database": "TFSES_ANALYTICS",
  "snowflake_layers": {
    "bronze": {
      "schema": "TFS_BRONZE",
      "description": "Raw data from source systems (AWS Glue → S3 → Snowflake)",
      "materialization": "table",
      "source_macro": "bronze"
    },
    "silver": {
      "schema": "TFS_SILVER",
      "description": "Cleaned and standardized data with light business logic",
      "materialization": "table_or_incremental",
      "prefixes": ["silver_adq", "silver_mas"]
    },
    "gold": {
      "schema": "TFS_GOLD",
      "description": "Dimensional models (facts and dimensions)",
      "materialization": "table_or_incremental",
      "prefixes": ["dim_", "fact_"]
    }
  },
  "schema_types": {
    "external": {
      "description": "External source databases loaded from S3 to Snowflake Bronze layer",
      "schemas": {
        "EKIP_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "EKIP",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "EKIP source system"
        },
        "MILES_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "MILES",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "Miles source system"
        },
        "TFSLINE_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "TFSLINE",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "TFS Line source system"
        },
        "EKIP_TFS_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "EKIP_TFS",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "EKIP TFS source system"
        },
        "PROFINANCE_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "PROFINANCE",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "ProFinance source system"
        },
        "3CX_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "C3X",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "3CX phone system (prefix C3X because Snowflake table names cannot start with numbers)"
        },
        "TES_SCHEMA": {
          "type": "external",
          "snowflake_prefix": "TES",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_BRONZE",
          "layer": "bronze",
          "description": "TES (Toyota España System) - Note: TES_DB, TES_HOST, TES_SERVER are AWS Glue configuration variables used for S3 data extraction, not needed for DBT models"
        }
      }
    },
    "internal": {
      "description": "Internal silver/gold tables generated by DBT transformations",
      "schemas": {
        "ODS_SCHEMA": {
          "type": "internal",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_SILVER",
          "layer": "silver",
          "table_prefixes": [
            "STG_",
            "MAS_",
            "silver_adq",
            "silver_mas"
          ],
          "description": "Operational Data Store - silver layer staging and master tables"
        },
        "DW_SCHEMA": {
          "type": "internal",
          "snowflake_database": "TFSES_ANALYTICS",
          "snowflake_schema": "TFS_GOLD",
          "layer": "gold",
          "table_prefixes": [
            "D_",
            "F_",
            "dim_",
            "fact_"
          ],
          "description": "Data warehouse dimensional models - gold layer"
        }
      }
    }
  },
  "table_naming_rules": {
    "external": {
      "format": "{snowflake_prefix}_{table_name}",
      "example": "EKIP_AFFAIRE",
      "description": "External tables use prefix-tablename format in Snowflake"
    },
    "internal": {
      "format": "{table_name}",
      "example": "STG_STATUS",
      "description": "Internal tables keep their original names"
    }
  },
  "dependency_tracking": {
    "track_internal_tables": true,
    "validate_chains": true,
    "description": "Track tables generated by transformations for dependency validation"
  },
  "connection_variables": {
    "description": "Connection variables used by AWS Glue for data extraction - NOT needed for DBT models",
    "variables": {
      "CISCO_SERVER": {
        "status": "deprecated",
        "description": "Cisco call center server connection - No longer used",
        "action": "Exclude adq_cisco_calldetail.ktr from migration"
      },
      "TES_DB": {
        "type": "aws_glue_config",
        "description": "TES database name - AWS Glue configuration for S3 extraction",
        "note": "Not needed for DBT models. DBT uses source() macro with TES_SCHEMA prefix"
      },
      "TES_HOST": {
        "type": "aws_glue_config",
        "description": "TES database host - AWS Glue configuration for S3 extraction",
        "note": "Not needed for DBT models. DBT uses source() macro with TES_SCHEMA prefix"
      },
      "TES_SERVER": {
        "type": "aws_glue_config",
        "description": "TES server connection - AWS Glue configuration for S3 extraction",
        "note": "Not needed for DBT models. DBT uses source() macro with TES_SCHEMA prefix"
      }
    }
  },
  "parameters": {
    "EKIP_FILTER_LANGUAGES": {
      "snowflake_name": "10",
      "type": "parameter",
      "data_type": "integer",
      "description": "Language filter for EKIP multilingual tables (10=Spanish, 4=English)",
      "usage": "WHERE CODE_LANGUE = ${EKIP_FILTER_LANGUAGES}",
      "note": "Used to filter multilingual reference tables to specific language"
    },
    "PROCESS_DATE_YYYYMMDD_HHMMSS": {
      "snowflake_name": "CURRENT_TIMESTAMP()",
      "type": "process_metadata",
      "dbt_equivalent": "{{ run_started_at }}",
      "description": "Process execution timestamp in YYYYMMDD_HHMMSS format"
    },
    "PROCESS_ID": {
      "snowflake_name": "'dbt_run'",
      "type": "process_metadata",
      "dbt_equivalent": "{{ invocation_id }}",
      "description": "Process execution identifier"
    }
  },
  "incremental_parameters": {
    "description": "Pentaho incremental load parameters - Handled by DBT incremental materialization strategy",
    "migration_strategy": "Replace Pentaho date-based filtering with DBT is_incremental() logic",
    "documentation": "See .claude/skills/dbt-best-practices/reference/repo_context/incremental_patterns.md",
    "examples": {
      "INC_DATE_FROM": {
        "pentaho_usage": "WHERE DATE_FIELD >= ${INC_DATE_FROM}",
        "dbt_equivalent": "{% if is_incremental() %} WHERE date_field >= {{ var('inc_date_from', 'default_date') }} {% endif %}",
        "note": "DBT handles incremental logic using is_incremental() block and var() for date parameters"
      },
      "MAX_PROCESS_DATE": {
        "pentaho_usage": "WHERE PROCESS_DATE <= ${MAX_PROCESS_DATE_TABLE}",
        "dbt_equivalent": "DBT incremental_strategy='merge' with unique_key handles this automatically",
        "note": "No explicit date filtering needed - DBT compares source vs target based on unique_key"
      },
      "DELTA_CONDITION": {
        "pentaho_usage": "WHERE ${DELTA_CONDITION}",
        "dbt_equivalent": "{% if is_incremental() %} WHERE id > (select max(id) from {{ this }}) {% endif %}",
        "note": "Use DBT {{ this }} to reference current model for delta detection"
      }
    },
    "common_patterns": [
      "Delta by ID: WHERE id > (select coalesce(max(id), 0) from {{ this }})",
      "Delta by date: WHERE date_field >= {{ var('inc_date', 'default') }}",
      "Combined: WHERE id > max_id OR date_field >= inc_date"
    ]
  },
  "excluded_files": {
    "description": "Files excluded from migration due to deprecated systems or data sources",
    "dim_contract": [
      {
        "file": "adq_cisco_calldetail.ktr",
        "reason": "Cisco connection no longer used",
        "excluded_date": "2025-10-28"
      }
    ]
  },
  "custom_functions": [
    {
      "name": "GETENUMML",
      "description": "Miles multilingual enumeration lookup - translates system enumerations to descriptive text",
      "preserve": false,
      "deployment_required": false,
      "expansion": {
        "expand_to_sql": true,
        "description": "Expands to SQL joins against MILES translation tables",
        "source_tables": [
          "MILES_SYSENUMERATION",
          "MILES_TRANSLATEDSTRING",
          "MILES_LANGUAGE"
        ],
        "cte_name": "enum_translations",
        "cte_sql": "SELECT\n    s.sysenumeration_id,\n    COALESCE(\n        t1.translation,\n        t2.translation,\n        s.description\n    ) AS description_ml\nFROM {{ source('bronze', 'MILES_SYSENUMERATION') }} s\nLEFT JOIN {{ source('bronze', 'MILES_TRANSLATEDSTRING') }} t1\n    ON t1.language_id = 4\n   AND t1.multilanguagestring_id = s.description_mlid\nLEFT JOIN {{ source('bronze', 'MILES_LANGUAGE') }} l\n    ON l.language_id = 4\nLEFT JOIN {{ source('bronze', 'MILES_TRANSLATEDSTRING') }} t2\n    ON l.parentlanguage_id = t2.language_id\n   AND t2.multilanguagestring_id = s.description_mlid",
        "replacement_instructions": {
          "pattern": "TFSES_ANALYTICS.TFS_SILVER.GETENUMML\\(([^,]+),\\s*4\\)",
          "replace_with": "e.description_ml",
          "join_to_add": "LEFT JOIN enum_translations e\n    ON {table_alias}.{field_name} = e.sysenumeration_id",
          "notes": "Replace UDF call with reference to CTE. Extract field name from first argument and use in join condition."
        }
      }
    }
  ]
}